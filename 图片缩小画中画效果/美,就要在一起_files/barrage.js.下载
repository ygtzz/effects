!function(e,t){function a(){90==t.orientation||t.orientation==-90?o.toast({content:"请在设备的竖屏状态下查看~~"}):t.location.reload()}function n(e,a){var n=a;e.addClass("effect").next(".msk").show(),t.waitTimer=setInterval(function(){(n-=1)<1&&(e.hasClass("effect")&&e.removeClass("effect").next(".msk").hide(),t.waitTimer&&clearInterval(t.waitTimer),n=0)},1e3)}var o=e("body"),i=e(t).width(),r=(e(this),{title:"美,就要在一起",activeId:"magpie20170707",max:105,line:4,speed:[120,125,130,135,140,150,155,160],isInfinite:!0,waitingTime:5});e.fn.toast=function(t){var a=e(this),n={display:"inline-block",position:"absolute",top:"50%",left:"50%",padding:"20px 15px",background:"rgba(7, 17, 27, 0.7)",borderRadius:"6px",content:"提示信息",color:"#fff",zIndex:99999,fontSize:"16px",closeDelay:4e3,opacity:.9,transform:"translate(-50%, -50%)",callback:""},o="",i=e.extend(n,t||{});!function(){e("._toast").length>0&&e("._toast").remove();var t=e("<span class='_toast'></span>").css({position:i.position,top:i.top,left:i.left,padding:i.padding,background:i.background,"border-radius":i.borderRadius,color:i.color,"z-index":i.zIndex,"font-size":i.fontSize,"-webkit-transform":i.transform,"-moz-transform":i.transform,"-m-transform":i.transform,"-o-transform":i.transform,transform:i.transform,opacity:i.opacity}).html(i.content).appendTo(a);o=setTimeout(function(){t.remove(),i.callback&&i.callback()},i.closeDelay)}()},Array.prototype._split=function(e){for(var t=[],a=0;a<this.length;a+=e)t.push(this.slice(a,a+e));return t};var c=function(e){var a=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),n=t.location.search.substr(1).match(a);return null!=n?unescape(n[2]):null},s={creatElement:function(t,a){var n=a,o="barrage_content_"+t,i=0,c=120,l=Math.floor(Math.random()*r.speed.length),d=r.speed[l],f='<div id="'+o+'" class="barrage_content" speed ="'+d+'">',p=e(".barrage_panel");e(o).length>0&&e(o).remove();for(var g=0;g<n.length;g++)f+=s.creatItem(n[g].id,n[g].headurl,n[g].barrageContent);f+="</div>",p.append(f);for(var u=e("#"+o+" .item"),g=0;g<u.length;g++)i+=Math.ceil(u[g].offsetWidth)+21;c=Math.ceil((i+750)/d),p.find("#"+o).css({width:i,display:"none"}),0==t&&p.find("#"+o).css({width:"100000%"}),s.setAnimation(t,c,i)},addElement:function(t,a){function n(){var a=e(i).find(".item[hide=true]");if(e(a).css({display:"block"}),a.length>0){o.css({opacity:"0"});for(var n=0,r=e(i).find(".item"),c=0;c<r.length;c++)n+=e(r[c]).width()+21;for(var c=0;c<a.length;c++)e(a[c]).attr("hide","false");var l=1*e(i).attr("speed"),d=l?l:d;timing=Math.ceil((n+750)/d),o.hide(),s.setAnimation(t,timing,n);setTimeout(function(){o.show(),o.css({opacity:"1"})},0)}}for(var o=e(".barrage_panel #barrage_content_"+t),i=o[0],c=o.length,l="",d=0;d<a.length;d++)l+=s.creatItem(a[d].id,a[d].headurl,a[d].barrageContent);if(c>0){for(var f=e(l).prependTo(o[0]),p=f.length,d=0;d<p;d++)e(f[d]).css({display:"none"}).attr("hide","true");var g=Math.floor(Math.random()*r.speed.length);r.speed[g];i.addEventListener("animationiteration",n,!1)}else s.creatElement(t,a),timer=setTimeout(function(){e(".barrage_panel #barrage_content_"+t).show()},1e3)},creatItem:function(e,t,a){if(e&&t&&a){a.length>50&&(a=a.substr(0,50));return'<div class="item"><span class="img" style="background-image: url('+t+')"></span><span class="txt">'+a+"</span></div>"}},setAnimation:function(t,a,n){var o=e("head"),c="#barrage_animatiom_"+t;o.find(c).length>0&&e(c).remove();var l=r.isInfinite?"infinite":"1",d='<style id="barrage_animatiom_'+t+'" type="text/css">',f="animation: barrage_keyframe_"+t+" "+a+"s linear "+l+";",p="@keyframes barrage_keyframe_"+t+" { 0% {transform:translate3d("+(i+50)+"px,0,0);}  100% {transform:translate3d(-"+n+"px,0,0);} } ";d+="#barrage_content_"+t+" {"+s.prefix(f)+"}"+s.prefix(p)+"</style>",o.append(d)},prefix:function(e){for(var t=["","-webkit-","-moz-","-ms-","-o-"],a=new RegExp("^@keyframes"),n=0;n<t.length;n++)t[n]=a.test(e)?"@"+t[n]+e.split("@")[1]:t[n]+e;return t.join("")}},l={goWxOauth:function(){return t.location.href="/weixin/v1/oauth2/oauth"},getOpenID:function(t){return new Promise(function(a,n){e.ajax({type:"get",url:"/weixin/v1/oauth2/code",data:{code:t},success:function(e){a(e)},error:function(e){n(e)}})})},getWxUserinfo:function(t){return new Promise(function(a,n){e.ajax({type:"get",url:"/weixin/v1/user/getUserInfo",data:{openId:t},success:function(e){a(e)},error:function(e){n(e)}})})},checkOpenId:function(t){return new Promise(function(a,n){e.ajax({type:"get",url:"/weixin/v1/oauth2/checkoauth",data:{openId:t},success:function(e){a(e)},error:function(e){n(e)}})})}},d={conectSocket:function(e,a,n){setTimeout(function(){t.socket="";var i="https:"===t.location.protocol,r=i?"wss:":"ws:",c=r+"//"+location.host+"/websocket?openId="+e+"&activeId="+a+"&headUrl="+n;if("WebSocket"in t)try{t.socket=new WebSocket(c)}catch(e){o.toast({content:"无法连接至弹幕弹幕系统，请稍后重试！"})}else o.toast({content:"抱歉！当前浏览器无法支持弹幕的播放!"});t.socket.onopen=function(){},t.socket.onmessage=function(e){var t=e.data;t&&(t=JSON.parse(e.data)),d.getMessage(t)},t.socket.onerror=function(){},t.socket.onclose=function(){}},0)},getMessage:function(a){switch(a.code){case"902":var n=a.data.barrages,i=a.data.selfMessages,c=[];if(n&&n.length>0){for(var l=0;l<n.length;l++){var f=n[l];f.id&&f.barrageContent&&f.headurl?c.push(f.id):n.splice(l,1)}if(i&&i.length>0)for(var l=0;l<i.length;l++){var p=i[l];p.id&&p.barrageContent&&p.headurl&&c.indexOf(p.id)==-1&&n.unshift(p)}n.length>r.max&&(n=n.slice(0,r.max)),n=n._split(Math.ceil(r.max/r.line));for(var l=0;l<n.length;l++)s.creatElement(l,n[l])}break;case"903":s.addElement(0,a.data);break;case"901":o.toast({content:"成功发送弹幕!"}),e(".edit_panel label").hasClass("effect")&&e(".edit_panel label").removeClass("effect").next(".msk").hide(),t.waitTimer&&clearInterval(t.waitTimer),"block"==e(".edit_panel").css("display")&&(e(".edit_panel .editor").val(""),e(".edit_panel .close").trigger("click"));break;case"003":case"001":case"006":case"004":e(".edit_panel label").hasClass("effect")&&(t.waitTimer&&clearInterval(t.waitTimer),e(".edit_panel label").removeClass("effect").next(".msk").hide()),o.toast({content:a.msg});break;case"002":o.toast({content:a.msg}),e(".edit_panel label").hasClass("effect")&&(t.waitTimer&&clearInterval(t.waitTimer),e(".edit_panel label").removeClass("effect").next(".msk").hide()),"block"==e(".edit_panel").css("display")&&(e(".edit_panel .editor").val(""),e(".edit_panel .close").trigger("click"));break;case"007":t.localStorage&&localStorage.clear(),d.close(),o.toast({content:"微信授权认证已过期，稍后请刷新重新认证~~"})}},sendMessage:function(e){t.socket&&e&&t.socket.send(e)},close:function(){t.socket&&t.socket.close()}};e("input").on("click",function(){e(this).focus()}),function(){e("title").html(r.title),e(t).bind("orientationchange",function(e){a()});var i="",s="",i="",f=t.localStorage,p=c("code")||"",g=/MicroMessenger/.test(t.navigator.userAgent);f&&(s=f.getItem("openId")||"",i=f.getItem("headimgurl")||""),s&&i?l.checkOpenId(s).then(function(e){e.data.isflag?d.conectSocket(s,r.activeId,i):(f.clear(),d.conectSocket("",r.activeId,""))}).catch(function(){d.conectSocket("",r.activeId,"")}):p?l.getOpenID(p).then(function(e){e.succeed&&(f&&(f.setItem("openId",e.data.openid),f.setItem("headimgurl",e.data.headimgurl)),d.conectSocket(e.data.openid,r.activeId,e.data.headimgurl))}).catch(function(e){}):d.conectSocket(s,r.activeId,i),e(".start").off("click").on("click",function(t){t.stopPropagation(),g?(s=localStorage.getItem("openId"),s?l.checkOpenId(s).then(function(t){t.data.isflag?(e(".edit_panel").show(),e("input").trigger("click")):(d.close(),l.goWxOauth())}).catch(function(){d.close(),l.goWxOauth()}):p?l.getOpenID(p).then(function(t){t.succeed&&(localStorage&&(localStorage.setItem("openId",t.data.openid),localStorage.setItem("headimgurl",t.data.headimgurl)),e(".edit_panel").show(),e("input").trigger("click"))}).catch(function(){o.toast({content:"微信认证已经过期，请刷新页面重试!",callback:function(){d.close(),l.goWxOauth()}})}):(d.close(),l.goWxOauth())):o.toast({content:"请在微信中打开~~"})}),e(".disable").off("click").on("click",function(t){if(t.stopPropagation(),$barrage=e(".barrage_panel .barrage_content"),!g)return void o.toast({content:"请在微信中打开~~"});var a=e(".edit_panel");"block"==a.css("display")&&(a.find("label").hasClass("effect")&&a.find("label").removeClass("effect"),a.hide().find(".editor").val("")),$barrage.length>0?"关闭"===e(this).text()?(e(this).text("打开"),$barrage.hide(),e(this).prev(".start").hide()):(e(this).text("关闭"),$barrage.show(),e(this).prev(".start").show()):o.toast({content:"还没有弹幕内容,快去发送弹幕吧~~"})}),e(".close").off("click").on("click",function(a){a.stopPropagation(),e(".edit_panel label").hasClass("effect")&&e(".edit_panel label").removeClass("effect"),e(".edit_panel, .msk").hide(),t.waitTimer&&clearInterval(t.waitTimer)}),e("label.send").off("click").on("click",function(a){a.stopPropagation();var i=e.trim(e("input[name=text]").val()),c=localStorage.getItem("openId");i?i.length>50?o.toast({content:"每条弹幕最多50个字，您超出了限制!"}):c&&1===t.socket.readyState?(d.sendMessage(e.trim(i)),n(e(this),r.waitingTime)):o.toast({content:"发送失败，弹幕系统连接异常，请刷新页面重试!"}):o.toast({content:"请输入弹幕内容!"})})}()}(Zepto,window);